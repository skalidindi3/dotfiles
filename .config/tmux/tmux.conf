# TODO: lint set/set-option

set -g mouse on

set -g history-limit 20000  # preserve large scrollback (10x default)

set -g base-index 1         # start at 1 instead of 0
set -g renumber-windows on  # renumber to keep contiguous numbering

set -s escape-time 10  # vim mode hack, http://superuser.com/a/252717/65504

set -g default-terminal "xterm-256color"                # set 256 colors
set-option -ga terminal-overrides ",xterm-256color:Tc"  # set 24b true color

# make clear-screen also clear scrollback
bind -n C-l send-keys -R C-l \; clear-history

# binding to reload config
bind C-r source-file ~/.config/tmux/tmux.conf \
    \; display-message "~/.config/tmux/tmux.conf reloaded"

# easy pane switching (keep holding ctrl)
bind C-p previous-window
bind C-n next-window

# preserve cwd for new panes
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# easy pane size-matching
bind C-v select-layout even-vertical
bind C-h select-layout even-horizontal

# bindings to save scrollback
bind C-s command-prompt -p "log pane to file:" \
    -I "/tmp/tmux.log" "capture-pane -S - ; save-buffer %1 ; delete-buffer"
bind S command-prompt -p "log pane (with escape codes) to file:" \
    -I "/tmp/tmux.log" "capture-pane -eS - ; save-buffer %1 ; delete-buffer"

# popups
bind C-t display-popup -E ncmpcpp -s playlist
bind C-g display-popup -E tmux new-session -A -s gpt-scratch \
    "bash -c ' \
        tmux set status off; \
        read -p \"Ask GPT: \" query; \
        tgpt --provider gemini --model gemini-2.5-flash --key $TGPT_GEMINI_API_KEY \"\$query\"'; \
        exec zsh -i"
# TODO:
# - C-c cheatsheet
# - lazygit?
# - tmux session manager?
# - ipython


# statusbar
# - layout (left)
#   - host
#   - session name
#   - pane_tty
#   - prefix indicator
# - layout (mid)
#   - windows
# - layout (right)
#   - current music
#     - python script limiting size, rotating carousel, inverting highlight buffer?



source-file ~/.config/tmux/tmux-colors.conf

# set host color based on hostname
run-shell "tmux set-option -g @host_color \"$(tmux show-option -gqv @nordic_blue1)\""
run-shell "tmux set-option -g @host_color_alt \"$(tmux show-option -gqv @nordic_orange_bright)\""


set -g status-interval 15

set -g status-left-length 60
set -g status-left "#[fg=#{@nordic_black0},bg=#{@host_color},bold] #h "
set -ga status-left "#[fg=#{@host_color},bg=#{@nordic_black0},nobold] [#S] "
set -ga status-left "#[fg=#{@nordic_gray4},bg=#{@nordic_black0},nobold]#{pane_tty} "
set -ga status-left "#{?client_prefix,#[fg=#{@nordic_black0} bg=#{@host_color_alt}] ^B #[default],}"

set -g status-justify absolute-centre
set -g status-style "fg=#{@nordic_gray4},bg=#{@nordic_black0},nobold"

set -g window-status-current-format "#[fg=#{@host_color},bg=#{@nordic_black0}] [ #I : #W#F ] "
set -g window-status-format " #I : #W#F "
set -g window-status-format " #{?window_last_flag,#[fg=#{@host_color_alt}]#I,#I}#[fg=#{@nordic_gray4}] : #W#F "
set -g window-status-separator " | "
#set -g window-status-current-format "#[fg=#{@nordic_black0},bg=#{@host_color},bold] #I: #W#F "
#set -g window-status-last-style "fg=#{@host_color},bg=#{@nordic_black0},nobold"

set -g status-right-length 60
set -g status-right "#[fg=#{@nordic_green_dim}]⏺︎ ⏸︎ ⏵︎ #(mpc | head -1)"

set -g message-command-style "fg=#{@host_color},bg=#{@nordic_black0}"
set -g message-style "fg=#{@nordic_black0},bg=#{@host_color_alt}"

set -g window-status-current-style "fg=#{@host_color}",bg=black
set -g pane-active-border-style "fg=#{@host_color}",bg=black


# set -g focus-events on
# set-hook -g pane-focus-out 'select-pane -P bg=colour0'
# set-hook -g pane-focus-in 'select-pane -P bg=default'






# NOTES
# easy session switching --> C-b s, OR :choose-tree
# https://robots.thoughtbot.com/a-tmux-crash-course


# platform-specific settings
#run-shell ~/.config/tmux/platform.tmux


# list of plugins
# NOTE: no tmux-sensible since i have it mostly covered above
set -g @plugin "tmux-plugins/tpm"

set -g @plugin "roosta/tmux-fuzzback"
set -g @fuzzback-bind /
# TODO: make fuzzback more obvious

# future plugins?
# tmux-menus (to document custom keymaps)
#   - maybe use display-popup instead? (with builtin shell read cmd?)
#   - TODO: for nvim also (g command examples, see https://www.youtube.com/watch?v=1M-XDGc20ns)
# tmux-resurrect
# tmux-continuum
# tmux-fingers
# tmux-cowboy

# initialize tmp (keep this line at the very bottom of tmux.conf)
run "~/.config/tmux/plugins/tpm/tpm"
# Install with prefix + I, update with prefix + u
