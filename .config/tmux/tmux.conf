# base tmux configuration

set -g mouse on

set -g history-limit 20000                      # preserve large scrollback (10x default)

set -g renumber-windows on                      # renumber to keep contiguous numbering
set -g base-index 1                             # window #s start at 1 instead of 0
set -g pane-base-index 1                        # pane #s start at 1 instead of 0
set -g display-panes-time 5000                  # time to choose panes
set -g display-time 2000                        # duration of statusbar messages

set -s escape-time 10                           # vim mode hack, http://superuser.com/a/252717/65504

set -g default-terminal "xterm-256color"        # set 256 colors
set -ga terminal-overrides ",xterm-256color:Tc" # set 24b true color

# make clear-screen also clear scrollback
bind -n C-l send-keys -R C-l \; clear-history

# binding to reload config
bind C-r source-file ~/.config/tmux/tmux.conf \
    \; display-message "~/.config/tmux/tmux.conf reloaded"

# easy pane switching (keep holding ctrl)
bind C-p previous-window
bind C-n next-window

# preserve cwd for new panes
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# bindings to save scrollback
bind C-s command-prompt -p "log pane to file:" \
    -I "/tmp/tmux.log" "capture-pane -S - ; save-buffer %1 ; delete-buffer"
bind S command-prompt -p "log pane (with escape codes) to file:" \
    -I "/tmp/tmux.log" "capture-pane -eS - ; save-buffer %1 ; delete-buffer"

# popups
# NOTE: zsh -i forces zshrc, which sets up aliases
bind i display-popup -h 80% -E "zsh -i -c ipython"
bind t display-popup -h 80% -E ncmpcpp
bind C-t display-popup -h 80% -E ncmpcpp
bind C-c display-popup -h 20 -w 60 ~/.config/tmux/scripts/cheatsheet.sh
bind C-g display-popup -h 80% -E tmux new-session -A -s gpt-scratch \
    "bash -c ' \
        tmux set status off; \
        read -p \"Ask GPT: \" query; \
        tgpt --provider gemini --model gemini-2.5-flash --key $TGPT_GEMINI_API_KEY \"\$query\"'; \
        exec zsh -i"
# FUTURE?:
# - lazygit

# styling: general colors
source-file ~/.config/tmux/scripts/nordic-colors.conf

# styling: statusbar command interface
set -g message-command-style "fg=#{@host_color},bg=#{@nordic_black0}"
set -g message-style "fg=#{@nordic_black0},bg=#{@host_color_alt}"

# styling: window & pane colors
set -g window-status-current-style "fg=#{@host_color}",bg=black
set -g pane-active-border-style "fg=#{@host_color}",bg=black

# styling: set host color based on hostname
run-shell ~/.config/tmux/scripts/set-host-colors.sh

# statusbar (left)
set -g status-left-length 60
# statusbar (left): host
set -g status-left "#[fg=#{@nordic_black0},bg=#{@host_color},bold] #h "
# statusbar (left): session name
set -ga status-left "#[fg=#{@host_color},bg=#{@nordic_black0},nobold] [#S] "
# statusbar (left): active pane tty
set -ga status-left "#[fg=#{@nordic_gray4},bg=#{@nordic_black0},nobold]#{pane_tty} "
# statusbar (left): prefix indicator
set -ga status-left "#{?client_prefix,#[fg=#{@nordic_black0} bg=#{@host_color_alt}] ^B #[default],}"

# statusbar (mid)
set -g status-justify absolute-centre
# statusbar (mid): windows list
set -g status-style "fg=#{@nordic_gray4},bg=#{@nordic_black0},nobold"
set -g window-status-current-format "#[fg=#{@host_color},bg=#{@nordic_black0}] [ #I : #W#F ] "
set -g window-status-format " #{?window_last_flag,#[fg=#{@host_color_alt}]#I,#I}#[fg=#{@nordic_gray4}] : #W#F "
set -g window-status-separator " | "

# statusbar (right)
set -g status-right-length 60
# statusbar (right): mpd info
set -g status-right "#(~/.config/tmux/scripts/mpd-info.sh)"

# statusbar update interval
# NOTE: this is set to 1 in ncmpcpp bindings and hooks to force an update
set -g @statusbar_interval_reset_value 15
run-shell "tmux set -g status-interval \
    \"$(tmux show-option -gqv @statusbar_interval_reset_value)\""

# styling: hooks for active panes
# set -g focus-events on
# set-hook -g pane-focus-out 'select-pane -P bg=colour0'
# set-hook -g pane-focus-in 'select-pane -P bg=default'

# plugins
# NOTE: no tmux-sensible since i have it mostly covered above
set -g @plugin "tmux-plugins/tpm"
set -g @plugin "roosta/tmux-fuzzback"
set -g @fuzzback-bind /
set -g @plugin 'yardnsm/tmux-1password'
set -g @1password-key '!'
# FUTURE?
# - laktak/extrakto, Morantron/tmux-fingers
# - tmux-resurrect
# - tmux-continuum
# - tmux-cowboy

# initialize tmp (keep this line at the very bottom of tmux.conf)
run "~/.config/tmux/plugins/tpm/tpm"
